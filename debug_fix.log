   Compiling tl v0.1.0 (/Users/junsuzuki/Program/Rust/tl)
warning: constant `TOTAL_MEMORY_BUDGET_BYTES` is never used
 --> src/runtime/memory_manager.rs:8:7
  |
8 | const TOTAL_MEMORY_BUDGET_BYTES: usize = 2 * 1024 * 1024 * 1024; // 2GB
  |       ^^^^^^^^^^^^^^^^^^^^^^^^^
  |
  = note: `#[warn(dead_code)]` on by default

warning: method `add_memory` is never used
   --> src/runtime/llm.rs:456:12
    |
409 | impl KVCacheManager {
    | ------------------- method in this implementation
...
456 |     pub fn add_memory(&mut self, bytes: usize) {
    |            ^^^^^^^^^^

warning: `tl` (bin "tl") generated 2 warnings
    Finished `release` profile [optimized] target(s) in 16.47s
     Running `target/release/tl run examples/apps/chatbot.tl`
Running file: "examples/apps/chatbot.tl"
Compiling Expr: FnCall("tl_tensor_map_get_1d", [Variable("map"), Variable("key")])
Compiling Expr: Variable("map")
Compiling Expr: Variable("key")
Compiling Expr: StructInit("RMSNorm", [("weight", Variable("w")), ("eps", Float(1e-5))])
Compiling Expr: Variable("w")
Compiling Expr: Float(1e-5)
Compiling Expr: FnCall("tl_tensor_rms_norm", [Variable("x"), FieldAccess(Variable("self"), "weight"), FieldAccess(Variable("self"), "eps")])
Compiling Expr: Variable("x")
Compiling Expr: FieldAccess(Variable("self"), "weight")
Compiling Expr: Variable("self")
Compiling Expr: FieldAccess(Variable("self"), "eps")
Compiling Expr: Variable("self")
Compiling Expr: FnCall("tl_tensor_map_get", [Variable("map"), Variable("key")])
Compiling Expr: Variable("map")
Compiling Expr: Variable("key")
Compiling Expr: StructInit("Linear", [("weight", Variable("w"))])
Compiling Expr: Variable("w")
Compiling Expr: FnCall("tl_tensor_transpose_2d", [FieldAccess(Variable("self"), "weight"), Int(0), Int(1)])
Compiling Expr: FieldAccess(Variable("self"), "weight")
Compiling Expr: Variable("self")
Compiling Expr: Int(0)
Compiling Expr: Int(1)
Compiling Expr: FnCall("tl_tensor_matmul", [Variable("x"), Variable("wt")])
Compiling Expr: Variable("x")
Compiling Expr: Variable("wt")
Compiling Expr: Variable("out")
Compiling Expr: StaticMethodCall("Linear", "from_map", [Variable("map"), FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_gate.weight")])])
Compiling Expr: Variable("map")
Compiling Expr: FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_gate.weight")])
Compiling Expr: Variable("prefix")
Compiling Expr: StringLiteral("_gate.weight")
Compiling Expr: StaticMethodCall("Linear", "from_map", [Variable("map"), FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_up.weight")])])
Compiling Expr: Variable("map")
Compiling Expr: FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_up.weight")])
Compiling Expr: Variable("prefix")
Compiling Expr: StringLiteral("_up.weight")
Compiling Expr: StaticMethodCall("Linear", "from_map", [Variable("map"), FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_down.weight")])])
Compiling Expr: Variable("map")
Compiling Expr: FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_down.weight")])
Compiling Expr: Variable("prefix")
Compiling Expr: StringLiteral("_down.weight")
Compiling Expr: StructInit("MLP", [("gate_proj", Variable("gate")), ("up_proj", Variable("up")), ("down_proj", Variable("down"))])
Compiling Expr: Variable("gate")
Compiling Expr: Variable("up")
Compiling Expr: Variable("down")
Compiling Expr: MethodCall(FieldAccess(Variable("self"), "gate_proj"), "forward", [MethodCall(Variable("x"), "clone", [])])
Compiling Expr: FieldAccess(Variable("self"), "gate_proj")
Compiling Expr: Variable("self")
Compiling Expr: MethodCall(Variable("x"), "clone", [])
Compiling Expr: Variable("x")
Compiling Expr: MethodCall(FieldAccess(Variable("self"), "up_proj"), "forward", [Variable("x")])
Compiling Expr: FieldAccess(Variable("self"), "up_proj")
Compiling Expr: Variable("self")
Compiling Expr: Variable("x")
Compiling Expr: FnCall("tl_tensor_silu", [Variable("g")])
Compiling Expr: Variable("g")
Compiling Expr: BinOp(Variable("silu_g"), Mul, Variable("u"))
Compiling Expr: Variable("silu_g")
Compiling Expr: Variable("u")
Compile BinOp: Mul Tensor(F32, 2) Tensor(F32, 2)
Compiling Expr: MethodCall(FieldAccess(Variable("self"), "down_proj"), "forward", [Variable("gu")])
Compiling Expr: FieldAccess(Variable("self"), "down_proj")
Compiling Expr: Variable("self")
Compiling Expr: Variable("gu")
Compiling Expr: Variable("d")
Compiling Expr: StaticMethodCall("Linear", "from_map", [Variable("map"), FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_q.weight")])])
Compiling Expr: Variable("map")
Compiling Expr: FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_q.weight")])
Compiling Expr: Variable("prefix")
Compiling Expr: StringLiteral("_q.weight")
Compiling Expr: StaticMethodCall("Linear", "from_map", [Variable("map"), FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_k.weight")])])
Compiling Expr: Variable("map")
Compiling Expr: FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_k.weight")])
Compiling Expr: Variable("prefix")
Compiling Expr: StringLiteral("_k.weight")
Compiling Expr: StaticMethodCall("Linear", "from_map", [Variable("map"), FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_v.weight")])])
Compiling Expr: Variable("map")
Compiling Expr: FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_v.weight")])
Compiling Expr: Variable("prefix")
Compiling Expr: StringLiteral("_v.weight")
Compiling Expr: StaticMethodCall("Linear", "from_map", [Variable("map"), FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_output.weight")])])
Compiling Expr: Variable("map")
Compiling Expr: FnCall("tl_string_concat", [Variable("prefix"), StringLiteral("_output.weight")])
Compiling Expr: Variable("prefix")
Compiling Expr: StringLiteral("_output.weight")
Compiling Expr: StructInit("Attention", [("q_proj", Variable("q")), ("k_proj", Variable("k")), ("v_proj", Variable("v")), ("o_proj", Variable("o")), ("n_heads", Int(32)), ("head_dim", Int(64))])
Compiling Expr: Variable("q")
Compiling Expr: Variable("k")
Compiling Expr: Variable("v")
Compiling Expr: Variable("o")
Compiling Expr: Int(32)
Compiling Expr: Int(64)
Compiling Expr: MethodCall(FieldAccess(Variable("self"), "q_proj"), "forward", [MethodCall(Variable("x"), "clone", [])])
Compiling Expr: FieldAccess(Variable("self"), "q_proj")
Compiling Expr: Variable("self")
Compiling Expr: MethodCall(Variable("x"), "clone", [])
Compiling Expr: Variable("x")
Compiling Expr: MethodCall(FieldAccess(Variable("self"), "k_proj"), "forward", [MethodCall(Variable("x"), "clone", [])])
Compiling Expr: FieldAccess(Variable("self"), "k_proj")
Compiling Expr: Variable("self")
Compiling Expr: MethodCall(Variable("x"), "clone", [])
Compiling Expr: Variable("x")
Compiling Expr: MethodCall(FieldAccess(Variable("self"), "v_proj"), "forward", [MethodCall(Variable("x"), "clone", [])])
Compiling Expr: FieldAccess(Variable("self"), "v_proj")
Compiling Expr: Variable("self")
Compiling Expr: MethodCall(Variable("x"), "clone", [])
Compiling Expr: Variable("x")
Compiling Expr: Int(1)
Compiling Expr: FnCall("tl_get_memory_mb", [])
Compiling Expr: FnCall("print", [FnCall("tl_string_concat", [FnCall("tl_string_concat", [FnCall("tl_string_concat", [StringLiteral("Layer "), FnCall("tl_string_from_int", [Variable("layer_idx")])]), FnCall("tl_string_concat", [StringLiteral(" Reshape (start_pos="), FnCall("tl_string_from_int", [Variable("start_pos")])])]), FnCall("tl_string_concat", [StringLiteral(") mem="), FnCall("tl_string_concat", [FnCall("tl_string_from_int", [Variable("mem_before")]), StringLiteral(" MB")])])])])
Compiling Expr: FnCall("tl_string_concat", [FnCall("tl_string_concat", [FnCall("tl_string_concat", [StringLiteral("Layer "), FnCall("tl_string_from_int", [Variable("layer_idx")])]), FnCall("tl_string_concat", [StringLiteral(" Reshape (start_pos="), FnCall("tl_string_from_int", [Variable("start_pos")])])]), FnCall("tl_string_concat", [StringLiteral(") mem="), FnCall("tl_string_concat", [FnCall("tl_string_from_int", [Variable("mem_before")]), StringLiteral(" MB")])])])
Compiling Expr: FnCall("tl_string_concat", [FnCall("tl_string_concat", [StringLiteral("Layer "), FnCall("tl_string_from_int", [Variable("layer_idx")])]), FnCall("tl_string_concat", [StringLiteral(" Reshape (start_pos="), FnCall("tl_string_from_int", [Variable("start_pos")])])])
Compiling Expr: FnCall("tl_string_concat", [StringLiteral("Layer "), FnCall("tl_string_from_int", [Variable("layer_idx")])])
Compiling Expr: StringLiteral("Layer ")
Compiling Expr: FnCall("tl_string_from_int", [Variable("layer_idx")])
Compiling Expr: Variable("layer_idx")
Compiling Expr: FnCall("tl_string_concat", [StringLiteral(" Reshape (start_pos="), FnCall("tl_string_from_int", [Variable("start_pos")])])
Compiling Expr: StringLiteral(" Reshape (start_pos=")
Compiling Expr: FnCall("tl_string_from_int", [Variable("start_pos")])
Compiling Expr: Variable("start_pos")
Compiling Expr: FnCall("tl_string_concat", [StringLiteral(") mem="), FnCall("tl_string_concat", [FnCall("tl_string_from_int", [Variable("mem_before")]), StringLiteral(" MB")])])
Compiling Expr: StringLiteral(") mem=")
Compiling Expr: FnCall("tl_string_concat", [FnCall("tl_string_from_int", [Variable("mem_before")]), StringLiteral(" MB")])
Compiling Expr: FnCall("tl_string_from_int", [Variable("mem_before")])
Compiling Expr: Variable("mem_before")
Compiling Expr: StringLiteral(" MB")
Compiling Expr: TensorLiteral([Variable("batch_size"), Variable("seq_len"), Int(32), Int(64)])
Compiling Expr: Variable("batch_size")
Compiling Expr: Variable("seq_len")
Compiling Expr: Int(32)
Compiling Expr: Int(64)
Compiling Expr: TensorLiteral([Variable("batch_size"), Variable("seq_len"), Int(4), Int(64)])
Compiling Expr: Variable("batch_size")
Compiling Expr: Variable("seq_len")
Compiling Expr: Int(4)
Compiling Expr: Int(64)
Compiling Expr: TensorLiteral([Variable("batch_size"), Variable("seq_len"), Int(4), Int(64)])
Compiling Expr: Variable("batch_size")
Compiling Expr: Variable("seq_len")
Compiling Expr: Int(4)
Compiling Expr: Int(64)
Compiling Expr: FnCall("tl_tensor_reshape_dims", [Variable("q"), Variable("q_shape"), Int(4)])
Compiling Expr: Variable("q")
Compiling Expr: Variable("q_shape")
Compiling Expr: Int(4)
Compiling Expr: FnCall("tl_tensor_reshape_dims", [Variable("k"), Variable("k_shape"), Int(4)])
Compiling Expr: Variable("k")
Compiling Expr: Variable("k_shape")
Compiling Expr: Int(4)
Compiling Expr: FnCall("tl_tensor_reshape_dims", [Variable("v"), Variable("v_shape"), Int(4)])
Compiling Expr: Variable("v")
Compiling Expr: Variable("v_shape")
Compiling Expr: Int(4)
Compiling Expr: FnCall("tl_tensor_narrow", [Variable("cos"), Int(0), Variable("start_pos"), Variable("seq_len")])
Compiling Expr: Variable("cos")
Compiling Expr: Int(0)
Compiling Expr: Variable("start_pos")
Compiling Expr: Variable("seq_len")
Compiling Expr: FnCall("tl_tensor_narrow", [Variable("sin"), Int(0), Variable("start_pos"), Variable("seq_len")])
Compiling Expr: Variable("sin")
Compiling Expr: Int(0)
Compiling Expr: Variable("start_pos")
Compiling Expr: Variable("seq_len")
Compiling Expr: FnCall("tl_tensor_apply_rope", [Variable("q_4d"), Variable("cos_slice"), Variable("sin_slice")])
Compiling Expr: Variable("q_4d")
Compiling Expr: Variable("cos_slice")
Compiling Expr: Variable("sin_slice")
Compiling Expr: FnCall("tl_tensor_apply_rope", [Variable("k_4d"), Variable("cos_slice"), Variable("sin_slice")])
Compiling Expr: Variable("k_4d")
Compiling Expr: Variable("cos_slice")
Compiling Expr: Variable("sin_slice")
Compiling Expr: FnCall("tl_tensor_transpose", [Variable("k_rope"), Int(1), Int(2)])
Compiling Expr: Variable("k_rope")
Compiling Expr: Int(1)
Compiling Expr: Int(2)
Compiling Expr: FnCall("tl_tensor_transpose", [Variable("v_4d"), Int(1), Int(2)])
Compiling Expr: Variable("v_4d")
Compiling Expr: Int(1)
Compiling Expr: Int(2)
Compiling Expr: IfExpr(BinOp(Variable("start_pos"), Eq, Int(0)), [Expr(Variable("k_trans"))], Some([Let { name: "past_k", type_annotation: None, value: FnCall("tl_kv_cache_get_k", [Variable("cache"), Variable("layer_idx")]) }, Expr(FnCall("tl_tensor_cat_4d", [Variable("past_k"), Variable("k_trans"), Int(2)]))]))
Compiling Expr: BinOp(Variable("start_pos"), Eq, Int(0))
Compiling Expr: Variable("start_pos")
Compiling Expr: Int(0)
Compile BinOp: Eq I64 I64
Compiling Expr: Variable("k_trans")
Compiling Expr: FnCall("tl_kv_cache_get_k", [Variable("cache"), Variable("layer_idx")])
Compiling Expr: Variable("cache")
Compiling Expr: Variable("layer_idx")
Compiling Expr: FnCall("tl_tensor_cat_4d", [Variable("past_k"), Variable("k_trans"), Int(2)])
Compiling Expr: Variable("past_k")
Compiling Expr: Variable("k_trans")
Compiling Expr: Int(2)
Compiling Expr: IfExpr(BinOp(Variable("start_pos"), Eq, Int(0)), [Expr(Variable("v_trans"))], Some([Let { name: "past_v", type_annotation: None, value: FnCall("tl_kv_cache_get_v", [Variable("cache"), Variable("layer_idx")]) }, Expr(FnCall("tl_tensor_cat_4d", [Variable("past_v"), Variable("v_trans"), Int(2)]))]))
Compiling Expr: BinOp(Variable("start_pos"), Eq, Int(0))
Compiling Expr: Variable("start_pos")
Compiling Expr: Int(0)
Compile BinOp: Eq I64 I64
Compiling Expr: Variable("v_trans")
Compiling Expr: FnCall("tl_kv_cache_get_v", [Variable("cache"), Variable("layer_idx")])
Compiling Expr: Variable("cache")
Compiling Expr: Variable("layer_idx")
Compiling Expr: FnCall("tl_tensor_cat_4d", [Variable("past_v"), Variable("v_trans"), Int(2)])
Compiling Expr: Variable("past_v")
Compiling Expr: Variable("v_trans")
Compiling Expr: Int(2)
Compiling Expr: FnCall("tl_kv_cache_update", [Variable("cache"), Variable("layer_idx"), MethodCall(Variable("k_total"), "clone", []), MethodCall(Variable("v_total"), "clone", [])])
Compiling Expr: Variable("cache")
Compiling Expr: Variable("layer_idx")
Compiling Expr: MethodCall(Variable("k_total"), "clone", [])
Compiling Expr: Variable("k_total")
Compiling Expr: MethodCall(Variable("v_total"), "clone", [])
Compiling Expr: Variable("v_total")
Compiling Expr: Variable("x")
Basic Block in function 'tl_Attention_forward' does not have terminator!
label %after_free
define ptr @tl_Attention_forward(ptr %self, ptr %x, ptr %cos, ptr %sin, i64 %seq_len, i64 %cache, i64 %layer_idx, i64 %start_pos) {
entry:
  %v_total = alloca ptr, align 16
  %past_v = alloca ptr, align 16
  %k_total = alloca ptr, align 16
  %past_k = alloca ptr, align 16
  %v_trans = alloca ptr, align 16
  %k_trans = alloca ptr, align 16
  %k_rope = alloca ptr, align 16
  %q_rope = alloca ptr, align 16
  %sin_slice = alloca ptr, align 16
  %cos_slice = alloca ptr, align 16
  %v_4d = alloca ptr, align 16
  %k_4d = alloca ptr, align 16
  %q_4d = alloca ptr, align 16
  %v_shape = alloca ptr, align 16
  %k_shape = alloca ptr, align 16
  %q_shape = alloca ptr, align 16
  %mem_before = alloca i64, align 16
  %batch_size = alloca i64, align 16
  %v = alloca ptr, align 16
  %k = alloca ptr, align 16
  %q = alloca ptr, align 16
  %start_pos8 = alloca i64, align 16
  %layer_idx7 = alloca i64, align 16
  %cache6 = alloca i64, align 16
  %seq_len5 = alloca i64, align 16
  %sin4 = alloca ptr, align 16
  %cos3 = alloca ptr, align 16
  %x2 = alloca ptr, align 16
  %self1 = alloca ptr, align 16
  call void @tl_mem_enter_scope()
  store ptr %self, ptr %self1, align 8
  store ptr %x, ptr %x2, align 8
  store ptr %cos, ptr %cos3, align 8
  store ptr %sin, ptr %sin4, align 8
  store i64 %seq_len, ptr %seq_len5, align 8
  store i64 %cache, ptr %cache6, align 8
  store i64 %layer_idx, ptr %layer_idx7, align 8
  store i64 %start_pos, ptr %start_pos8, align 8
  %self9 = load ptr, ptr %self1, align 8
  %ptr_q_proj = getelementptr inbounds %Attention, ptr %self9, i32 0, i32 0
  %q_proj = load ptr, ptr %ptr_q_proj, align 8
  %x10 = load ptr, ptr %x2, align 8
  %clone_res = call ptr @tl_tensor_clone(ptr %x10)
  call void @tl_mem_register_tensor(ptr %clone_res)
  %call_method = call ptr @tl_Linear_forward(ptr %q_proj, ptr %clone_res)
  call void @tl_mem_register_tensor(ptr %call_method)
  call void @tl_tensor_acquire(ptr %call_method)
  store ptr %call_method, ptr %q, align 8
  %self11 = load ptr, ptr %self1, align 8
  %ptr_k_proj = getelementptr inbounds %Attention, ptr %self11, i32 0, i32 1
  %k_proj = load ptr, ptr %ptr_k_proj, align 8
  %x12 = load ptr, ptr %x2, align 8
  %clone_res13 = call ptr @tl_tensor_clone(ptr %x12)
  call void @tl_mem_register_tensor(ptr %clone_res13)
  %call_method14 = call ptr @tl_Linear_forward(ptr %k_proj, ptr %clone_res13)
  call void @tl_mem_register_tensor(ptr %call_method14)
  call void @tl_tensor_acquire(ptr %call_method14)
  store ptr %call_method14, ptr %k, align 8
  %self15 = load ptr, ptr %self1, align 8
  %ptr_v_proj = getelementptr inbounds %Attention, ptr %self15, i32 0, i32 2
  %v_proj = load ptr, ptr %ptr_v_proj, align 8
  %x16 = load ptr, ptr %x2, align 8
  %clone_res17 = call ptr @tl_tensor_clone(ptr %x16)
  call void @tl_mem_register_tensor(ptr %clone_res17)
  %call_method18 = call ptr @tl_Linear_forward(ptr %v_proj, ptr %clone_res17)
  call void @tl_mem_register_tensor(ptr %call_method18)
  call void @tl_tensor_acquire(ptr %call_method18)
  store ptr %call_method18, ptr %v, align 8
  store i64 1, ptr %batch_size, align 8
  %call_tmp = call i64 @tl_get_memory_mb()
  store i64 %call_tmp, ptr %mem_before, align 8
  %string_obj = call ptr @tl_string_new(ptr @str_lit.173)
  %layer_idx19 = load i64, ptr %layer_idx7, align 8
  %call_tmp20 = call ptr @tl_string_from_int(i64 %layer_idx19)
  %call_tmp21 = call ptr @tl_string_concat(ptr %string_obj, ptr %call_tmp20)
  %string_obj22 = call ptr @tl_string_new(ptr @str_lit.174)
  %start_pos23 = load i64, ptr %start_pos8, align 8
  %call_tmp24 = call ptr @tl_string_from_int(i64 %start_pos23)
  %call_tmp25 = call ptr @tl_string_concat(ptr %string_obj22, ptr %call_tmp24)
  %call_tmp26 = call ptr @tl_string_concat(ptr %call_tmp21, ptr %call_tmp25)
  %string_obj27 = call ptr @tl_string_new(ptr @str_lit.175)
  %mem_before28 = load i64, ptr %mem_before, align 8
  %call_tmp29 = call ptr @tl_string_from_int(i64 %mem_before28)
  %string_obj30 = call ptr @tl_string_new(ptr @str_lit.176)
  %call_tmp31 = call ptr @tl_string_concat(ptr %call_tmp29, ptr %string_obj30)
  %call_tmp32 = call ptr @tl_string_concat(ptr %string_obj27, ptr %call_tmp31)
  %call_tmp33 = call ptr @tl_string_concat(ptr %call_tmp26, ptr %call_tmp32)
  call void @tl_print_string(ptr %call_tmp33)
  %buf_void = call ptr @tl_alloc_tmp(i64 16)
  %batch_size34 = load i64, ptr %batch_size, align 8
  %i2f = sitofp i64 %batch_size34 to float
  %elem_ptr = getelementptr inbounds float, ptr %buf_void, i64 0
  store float %i2f, ptr %elem_ptr, align 4
  %seq_len35 = load i64, ptr %seq_len5, align 8
  %i2f36 = sitofp i64 %seq_len35 to float
  %elem_ptr37 = getelementptr inbounds float, ptr %buf_void, i64 1
  store float %i2f36, ptr %elem_ptr37, align 4
  %elem_ptr38 = getelementptr inbounds float, ptr %buf_void, i64 2
  store float 3.200000e+01, ptr %elem_ptr38, align 4
  %elem_ptr39 = getelementptr inbounds float, ptr %buf_void, i64 3
  store float 6.400000e+01, ptr %elem_ptr39, align 4
  %shape_alloc = call ptr @tl_alloc_tmp(i64 8)
  %shape_ptr = getelementptr inbounds i64, ptr %shape_alloc, i64 0
  store i64 4, ptr %shape_ptr, align 8
  %new_tensor = call ptr @tl_tensor_new(ptr %buf_void, i64 1, ptr %shape_alloc)
  call void @tl_free_tmp(ptr %buf_void)
  call void @tl_free_tmp(ptr %shape_alloc)
  call void @tl_tensor_acquire(ptr %new_tensor)
  store ptr %new_tensor, ptr %q_shape, align 8
  %buf_void40 = call ptr @tl_alloc_tmp(i64 16)
  %batch_size41 = load i64, ptr %batch_size, align 8
  %i2f42 = sitofp i64 %batch_size41 to float
  %elem_ptr43 = getelementptr inbounds float, ptr %buf_void40, i64 0
  store float %i2f42, ptr %elem_ptr43, align 4
  %seq_len44 = load i64, ptr %seq_len5, align 8
  %i2f45 = sitofp i64 %seq_len44 to float
  %elem_ptr46 = getelementptr inbounds float, ptr %buf_void40, i64 1
  store float %i2f45, ptr %elem_ptr46, align 4
  %elem_ptr47 = getelementptr inbounds float, ptr %buf_void40, i64 2
  store float 4.000000e+00, ptr %elem_ptr47, align 4
  %elem_ptr48 = getelementptr inbounds float, ptr %buf_void40, i64 3
  store float 6.400000e+01, ptr %elem_ptr48, align 4
  %shape_alloc49 = call ptr @tl_alloc_tmp(i64 8)
  %shape_ptr50 = getelementptr inbounds i64, ptr %shape_alloc49, i64 0
  store i64 4, ptr %shape_ptr50, align 8
  %new_tensor51 = call ptr @tl_tensor_new(ptr %buf_void40, i64 1, ptr %shape_alloc49)
  call void @tl_free_tmp(ptr %buf_void40)
  call void @tl_free_tmp(ptr %shape_alloc49)
  call void @tl_tensor_acquire(ptr %new_tensor51)
  store ptr %new_tensor51, ptr %k_shape, align 8
  %buf_void52 = call ptr @tl_alloc_tmp(i64 16)
  %batch_size53 = load i64, ptr %batch_size, align 8
  %i2f54 = sitofp i64 %batch_size53 to float
  %elem_ptr55 = getelementptr inbounds float, ptr %buf_void52, i64 0
  store float %i2f54, ptr %elem_ptr55, align 4
  %seq_len56 = load i64, ptr %seq_len5, align 8
  %i2f57 = sitofp i64 %seq_len56 to float
  %elem_ptr58 = getelementptr inbounds float, ptr %buf_void52, i64 1
  store float %i2f57, ptr %elem_ptr58, align 4
  %elem_ptr59 = getelementptr inbounds float, ptr %buf_void52, i64 2
  store float 4.000000e+00, ptr %elem_ptr59, align 4
  %elem_ptr60 = getelementptr inbounds float, ptr %buf_void52, i64 3
  store float 6.400000e+01, ptr %elem_ptr60, align 4
  %shape_alloc61 = call ptr @tl_alloc_tmp(i64 8)
  %shape_ptr62 = getelementptr inbounds i64, ptr %shape_alloc61, i64 0
  store i64 4, ptr %shape_ptr62, align 8
  %new_tensor63 = call ptr @tl_tensor_new(ptr %buf_void52, i64 1, ptr %shape_alloc61)
  call void @tl_free_tmp(ptr %buf_void52)
  call void @tl_free_tmp(ptr %shape_alloc61)
  call void @tl_tensor_acquire(ptr %new_tensor63)
  store ptr %new_tensor63, ptr %v_shape, align 8
  %q64 = load ptr, ptr %q, align 8
  %q_shape65 = load ptr, ptr %q_shape, align 8
  %call_tmp66 = call ptr @tl_tensor_reshape_dims(ptr %q64, ptr %q_shape65, i64 4)
  call void @tl_mem_register_tensor(ptr %call_tmp66)
  call void @tl_tensor_acquire(ptr %call_tmp66)
  store ptr %call_tmp66, ptr %q_4d, align 8
  %k67 = load ptr, ptr %k, align 8
  %k_shape68 = load ptr, ptr %k_shape, align 8
  %call_tmp69 = call ptr @tl_tensor_reshape_dims(ptr %k67, ptr %k_shape68, i64 4)
  call void @tl_mem_register_tensor(ptr %call_tmp69)
  call void @tl_tensor_acquire(ptr %call_tmp69)
  store ptr %call_tmp69, ptr %k_4d, align 8
  %v70 = load ptr, ptr %v, align 8
  %v_shape71 = load ptr, ptr %v_shape, align 8
  %call_tmp72 = call ptr @tl_tensor_reshape_dims(ptr %v70, ptr %v_shape71, i64 4)
  call void @tl_mem_register_tensor(ptr %call_tmp72)
  call void @tl_tensor_acquire(ptr %call_tmp72)
  store ptr %call_tmp72, ptr %v_4d, align 8
  %cos73 = load ptr, ptr %cos3, align 8
  %start_pos74 = load i64, ptr %start_pos8, align 8
  %seq_len75 = load i64, ptr %seq_len5, align 8
  %call_tmp76 = call ptr @tl_tensor_narrow(ptr %cos73, i64 0, i64 %start_pos74, i64 %seq_len75)
  call void @tl_mem_register_tensor(ptr %call_tmp76)
  call void @tl_tensor_acquire(ptr %call_tmp76)
  store ptr %call_tmp76, ptr %cos_slice, align 8
  %sin77 = load ptr, ptr %sin4, align 8
  %start_pos78 = load i64, ptr %start_pos8, align 8
  %seq_len79 = load i64, ptr %seq_len5, align 8
  %call_tmp80 = call ptr @tl_tensor_narrow(ptr %sin77, i64 0, i64 %start_pos78, i64 %seq_len79)
  call void @tl_mem_register_tensor(ptr %call_tmp80)
  call void @tl_tensor_acquire(ptr %call_tmp80)
  store ptr %call_tmp80, ptr %sin_slice, align 8
  %q_4d81 = load ptr, ptr %q_4d, align 8
  %cos_slice82 = load ptr, ptr %cos_slice, align 8
  %sin_slice83 = load ptr, ptr %sin_slice, align 8
  %call_tmp84 = call ptr @tl_tensor_apply_rope(ptr %q_4d81, ptr %cos_slice82, ptr %sin_slice83)
  call void @tl_mem_register_tensor(ptr %call_tmp84)
  call void @tl_tensor_acquire(ptr %call_tmp84)
  store ptr %call_tmp84, ptr %q_rope, align 8
  %k_4d85 = load ptr, ptr %k_4d, align 8
  %cos_slice86 = load ptr, ptr %cos_slice, align 8
  %sin_slice87 = load ptr, ptr %sin_slice, align 8
  %call_tmp88 = call ptr @tl_tensor_apply_rope(ptr %k_4d85, ptr %cos_slice86, ptr %sin_slice87)
  call void @tl_mem_register_tensor(ptr %call_tmp88)
  call void @tl_tensor_acquire(ptr %call_tmp88)
  store ptr %call_tmp88, ptr %k_rope, align 8
  %k_rope89 = load ptr, ptr %k_rope, align 8
  %call_tmp90 = call ptr @tl_tensor_transpose(ptr %k_rope89, i64 1, i64 2)
  call void @tl_mem_register_tensor(ptr %call_tmp90)
  call void @tl_tensor_acquire(ptr %call_tmp90)
  store ptr %call_tmp90, ptr %k_trans, align 8
  %v_4d91 = load ptr, ptr %v_4d, align 8
  %call_tmp92 = call ptr @tl_tensor_transpose(ptr %v_4d91, i64 1, i64 2)
  call void @tl_mem_register_tensor(ptr %call_tmp92)
  call void @tl_tensor_acquire(ptr %call_tmp92)
  store ptr %call_tmp92, ptr %v_trans, align 8
  %start_pos93 = load i64, ptr %start_pos8, align 8
  %eqtmp = icmp eq i64 %start_pos93, 0
  br i1 %eqtmp, label %if_then, label %if_else

if_then:                                          ; preds = %entry
  call void @tl_mem_enter_scope()
  %k_trans94 = load ptr, ptr %k_trans, align 8
  call void @tl_mem_exit_scope()
  br label %if_merge

if_else:                                          ; preds = %entry
  call void @tl_mem_enter_scope()
  %cache95 = load i64, ptr %cache6, align 8
  %layer_idx96 = load i64, ptr %layer_idx7, align 8
  %call_tmp97 = call ptr @tl_kv_cache_get_k(i64 %cache95, i64 %layer_idx96)
  call void @tl_mem_register_tensor(ptr %call_tmp97)
  call void @tl_tensor_acquire(ptr %call_tmp97)
  store ptr %call_tmp97, ptr %past_k, align 8
  %past_k98 = load ptr, ptr %past_k, align 8
  %k_trans99 = load ptr, ptr %k_trans, align 8
  %call_tmp100 = call ptr @tl_tensor_cat_4d(ptr %past_k98, ptr %k_trans99, i64 2)
  call void @tl_mem_register_tensor(ptr %call_tmp100)
  %tensor_to_free = load ptr, ptr %past_k, align 8
  %is_null = icmp eq ptr %tensor_to_free, null
  br i1 %is_null, label %after_free, label %free_tensor

if_merge:                                         ; preds = %if_then
  %if_result = phi ptr [ %k_trans94, %if_then ], [ %call_tmp100, %if_else ]
  call void @tl_tensor_acquire(ptr %if_result)
  store ptr %if_result, ptr %k_total, align 8
  %start_pos101 = load i64, ptr %start_pos8, align 8
  %eqtmp102 = icmp eq i64 %start_pos101, 0
  br i1 %eqtmp102, label %if_then103, label %if_else104

free_tensor:                                      ; preds = %if_else
  call void @tl_tensor_release(ptr %tensor_to_free)
  br label %after_free

after_free:                                       ; preds = %free_tensor, %if_else
  call void @tl_mem_exit_scope()

if_then103:                                       ; preds = %if_merge
  call void @tl_mem_enter_scope()
  %v_trans106 = load ptr, ptr %v_trans, align 8
  call void @tl_mem_exit_scope()
  br label %if_merge105

if_else104:                                       ; preds = %if_merge
  call void @tl_mem_enter_scope()
  %cache107 = load i64, ptr %cache6, align 8
  %layer_idx108 = load i64, ptr %layer_idx7, align 8
  %call_tmp109 = call ptr @tl_kv_cache_get_v(i64 %cache107, i64 %layer_idx108)
  call void @tl_mem_register_tensor(ptr %call_tmp109)
  call void @tl_tensor_acquire(ptr %call_tmp109)
  store ptr %call_tmp109, ptr %past_v, align 8
  %past_v110 = load ptr, ptr %past_v, align 8
  %v_trans111 = load ptr, ptr %v_trans, align 8
  %call_tmp112 = call ptr @tl_tensor_cat_4d(ptr %past_v110, ptr %v_trans111, i64 2)
  call void @tl_mem_register_tensor(ptr %call_tmp112)
  %tensor_to_free113 = load ptr, ptr %past_v, align 8
  %is_null116 = icmp eq ptr %tensor_to_free113, null
  br i1 %is_null116, label %after_free115, label %free_tensor114

if_merge105:                                      ; preds = %if_then103
  %if_result117 = phi ptr [ %v_trans106, %if_then103 ], [ %call_tmp112, %if_else104 ]
  call void @tl_tensor_acquire(ptr %if_result117)
  store ptr %if_result117, ptr %v_total, align 8
  %cache118 = load i64, ptr %cache6, align 8
  %layer_idx119 = load i64, ptr %layer_idx7, align 8
  %k_total120 = load ptr, ptr %k_total, align 8
  %clone_res121 = call ptr @tl_tensor_clone(ptr %k_total120)
  call void @tl_mem_register_tensor(ptr %clone_res121)
  %v_total122 = load ptr, ptr %v_total, align 8
  %clone_res123 = call ptr @tl_tensor_clone(ptr %v_total122)
  call void @tl_mem_register_tensor(ptr %clone_res123)
  call void @tl_kv_cache_update(i64 %cache118, i64 %layer_idx119, ptr %clone_res121, ptr %clone_res123)
  %x124 = load ptr, ptr %x2, align 8
  call void @tl_tensor_acquire(ptr %x124)
  %tensor_to_free125 = load ptr, ptr %v_4d, align 8
  %is_null128 = icmp eq ptr %tensor_to_free125, null
  br i1 %is_null128, label %after_free127, label %free_tensor126

free_tensor114:                                   ; preds = %if_else104
  call void @tl_tensor_release(ptr %tensor_to_free113)
  br label %after_free115

after_free115:                                    ; preds = %free_tensor114, %if_else104
  call void @tl_mem_exit_scope()

free_tensor126:                                   ; preds = %if_merge105
  call void @tl_tensor_release(ptr %tensor_to_free125)
  br label %after_free127

after_free127:                                    ; preds = %free_tensor126, %if_merge105
  %tensor_to_free129 = load ptr, ptr %q, align 8
  %is_null132 = icmp eq ptr %tensor_to_free129, null
  br i1 %is_null132, label %after_free131, label %free_tensor130

free_tensor130:                                   ; preds = %after_free127
  call void @tl_tensor_release(ptr %tensor_to_free129)
  br label %after_free131

after_free131:                                    ; preds = %free_tensor130, %after_free127
  %tensor_to_free133 = load ptr, ptr %v_shape, align 8
  %is_null136 = icmp eq ptr %tensor_to_free133, null
  br i1 %is_null136, label %after_free135, label %free_tensor134

free_tensor134:                                   ; preds = %after_free131
  call void @tl_tensor_release(ptr %tensor_to_free133)
  br label %after_free135

after_free135:                                    ; preds = %free_tensor134, %after_free131
  %tensor_to_free137 = load ptr, ptr %k_trans, align 8
  %is_null140 = icmp eq ptr %tensor_to_free137, null
  br i1 %is_null140, label %after_free139, label %free_tensor138

free_tensor138:                                   ; preds = %after_free135
  call void @tl_tensor_release(ptr %tensor_to_free137)
  br label %after_free139

after_free139:                                    ; preds = %free_tensor138, %after_free135
  %tensor_to_free141 = load ptr, ptr %q_4d, align 8
  %is_null144 = icmp eq ptr %tensor_to_free141, null
  br i1 %is_null144, label %after_free143, label %free_tensor142

free_tensor142:                                   ; preds = %after_free139
  call void @tl_tensor_release(ptr %tensor_to_free141)
  br label %after_free143

after_free143:                                    ; preds = %free_tensor142, %after_free139
  %tensor_to_free145 = load ptr, ptr %k, align 8
  %is_null148 = icmp eq ptr %tensor_to_free145, null
  br i1 %is_null148, label %after_free147, label %free_tensor146

free_tensor146:                                   ; preds = %after_free143
  call void @tl_tensor_release(ptr %tensor_to_free145)
  br label %after_free147

after_free147:                                    ; preds = %free_tensor146, %after_free143
  %tensor_to_free149 = load ptr, ptr %k_4d, align 8
  %is_null152 = icmp eq ptr %tensor_to_free149, null
  br i1 %is_null152, label %after_free151, label %free_tensor150

free_tensor150:                                   ; preds = %after_free147
  call void @tl_tensor_release(ptr %tensor_to_free149)
  br label %after_free151

after_free151:                                    ; preds = %free_tensor150, %after_free147
  %tensor_to_free153 = load ptr, ptr %v_total, align 8
  %is_null156 = icmp eq ptr %tensor_to_free153, null
  br i1 %is_null156, label %after_free155, label %free_tensor154

free_tensor154:                                   ; preds = %after_free151
  call void @tl_tensor_release(ptr %tensor_to_free153)
  br label %after_free155

after_free155:                                    ; preds = %free_tensor154, %after_free151
  %tensor_to_free157 = load ptr, ptr %k_shape, align 8
  %is_null160 = icmp eq ptr %tensor_to_free157, null
  br i1 %is_null160, label %after_free159, label %free_tensor158

free_tensor158:                                   ; preds = %after_free155
  call void @tl_tensor_release(ptr %tensor_to_free157)
  br label %after_free159

after_free159:                                    ; preds = %free_tensor158, %after_free155
  %tensor_to_free161 = load ptr, ptr %k_total, align 8
  %is_null164 = icmp eq ptr %tensor_to_free161, null
  br i1 %is_null164, label %after_free163, label %free_tensor162

free_tensor162:                                   ; preds = %after_free159
  call void @tl_tensor_release(ptr %tensor_to_free161)
  br label %after_free163

after_free163:                                    ; preds = %free_tensor162, %after_free159
  %tensor_to_free165 = load ptr, ptr %v_trans, align 8
  %is_null168 = icmp eq ptr %tensor_to_free165, null
  br i1 %is_null168, label %after_free167, label %free_tensor166

free_tensor166:                                   ; preds = %after_free163
  call void @tl_tensor_release(ptr %tensor_to_free165)
  br label %after_free167

after_free167:                                    ; preds = %free_tensor166, %after_free163
  %tensor_to_free169 = load ptr, ptr %cos_slice, align 8
  %is_null172 = icmp eq ptr %tensor_to_free169, null
  br i1 %is_null172, label %after_free171, label %free_tensor170

free_tensor170:                                   ; preds = %after_free167
  call void @tl_tensor_release(ptr %tensor_to_free169)
  br label %after_free171

after_free171:                                    ; preds = %free_tensor170, %after_free167
  %tensor_to_free173 = load ptr, ptr %k_rope, align 8
  %is_null176 = icmp eq ptr %tensor_to_free173, null
  br i1 %is_null176, label %after_free175, label %free_tensor174

free_tensor174:                                   ; preds = %after_free171
  call void @tl_tensor_release(ptr %tensor_to_free173)
  br label %after_free175

after_free175:                                    ; preds = %free_tensor174, %after_free171
  %tensor_to_free177 = load ptr, ptr %q_rope, align 8
  %is_null180 = icmp eq ptr %tensor_to_free177, null
  br i1 %is_null180, label %after_free179, label %free_tensor178

free_tensor178:                                   ; preds = %after_free175
  call void @tl_tensor_release(ptr %tensor_to_free177)
  br label %after_free179

after_free179:                                    ; preds = %free_tensor178, %after_free175
  %tensor_to_free181 = load ptr, ptr %v, align 8
  %is_null184 = icmp eq ptr %tensor_to_free181, null
  br i1 %is_null184, label %after_free183, label %free_tensor182

free_tensor182:                                   ; preds = %after_free179
  call void @tl_tensor_release(ptr %tensor_to_free181)
  br label %after_free183

after_free183:                                    ; preds = %free_tensor182, %after_free179
  %tensor_to_free185 = load ptr, ptr %q_shape, align 8
  %is_null188 = icmp eq ptr %tensor_to_free185, null
  br i1 %is_null188, label %after_free187, label %free_tensor186

free_tensor186:                                   ; preds = %after_free183
  call void @tl_tensor_release(ptr %tensor_to_free185)
  br label %after_free187

after_free187:                                    ; preds = %free_tensor186, %after_free183
  %tensor_to_free189 = load ptr, ptr %sin_slice, align 8
  %is_null192 = icmp eq ptr %tensor_to_free189, null
  br i1 %is_null192, label %after_free191, label %free_tensor190

free_tensor190:                                   ; preds = %after_free187
  call void @tl_tensor_release(ptr %tensor_to_free189)
  br label %after_free191

after_free191:                                    ; preds = %free_tensor190, %after_free187
  call void @tl_mem_exit_scope()
  ret ptr %x124
}

thread 'main' panicked at src/main.rs:103:42:
called `Result::unwrap()` on an `Err` value: "Invalid generated method tl_Attention_forward"
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
