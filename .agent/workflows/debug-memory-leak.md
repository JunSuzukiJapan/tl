---
description: セグメンテーションフォールとが起きる時に確認するべきこと
---

セグメンテーションフォールとが起きる時は次の点を確認してください。

1. 新しく追加した機能がマッピングされているか
2. 新しく追加したコードが、メモリ管理戦略(@docs/MEMORY_MANAGEMENT_STRATEGY.md) に反していないか
3. **ABI不整合 (Compiler vs Runtime)**:
   - **症状**: 外部関数呼び出し時 (`tl_tensor_embedding` など) に即座にクラッシュする。
   - **原因**: コンパイラの最適化（例: 小さな配列 `[1, 15043]` を `ScalarArray` として扱う）とランタイムの期待（`OpaqueTensor*` 構造体ポインタ）が食い違っている。
   - **対策**: `codegen/expr.rs` 等で、外部関数に渡すオブジェクトが必ず期待される型（`OpaqueTensor`）として生成されているか確認する。最適化を無効化するか、明示的な変換を行う。
4. **JITマッピングの欠如**:
   - **症状**: コンパイルは通るが、実行時にクラッシュする（特定の関数呼び出しで）。
   - **原因**: `codegen/builtins.rs` などで `add_global_mapping` が行われていない関数を呼び出している。
   - **対策**: 新しいランタイム関数を追加した際は、必ず JIT エンジンへのマッピングを追加する。